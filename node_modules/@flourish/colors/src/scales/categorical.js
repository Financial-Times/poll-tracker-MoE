import { set as d3_set } from "d3-collection";
import { hclGenerator, hslGenerator } from "@flourish/color-generator";
import { DEFAULTS } from "../defaults";

var color_generators = {
	hcl: hclGenerator,
	hsl: hslGenerator
};


function getCategoricalFunction(state, domain) {
	var lookup = {};

	var unique_domain = d3_set(domain).values();
	var palette = state.categorical_palette;
	var n = palette.length;

	if (state.categorical_extend) {
		var angle = DEFAULTS.rotation_angle;
		var generator_name = "hcl";
		var colorGenerator = color_generators[generator_name](palette, angle);
		unique_domain.forEach(function(label, i) {
			if (i < n) lookup[label] = palette[i];
			else lookup[label] = colorGenerator();
		});
	}
	else {
		unique_domain.forEach(function(label, i) {
			lookup[label] = palette[i % n];
		});
	}

	state.categorical_custom_palette.split("\n")
		.filter(function(str) { return str; }) // remove empty lines
		.forEach(function(str) {
			var index = str.lastIndexOf(":");
			if (index === -1) return;
			var label = str.slice(0, index).trim();
			var col = str.slice(index + 1).trim();
			if (label && col) lookup[label] = col;
		});

	var colorScale =  function(value) {
		return lookup[value];
	};

	colorScale.domain = unique_domain.slice();
	colorScale.colors = unique_domain.map(function(d) { return lookup[d]; });
	colorScale.items = unique_domain.map(function(d) { return { label: d, color: lookup[d] }; });

	return colorScale;
}


export { getCategoricalFunction };
