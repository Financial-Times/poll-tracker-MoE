const panel_animation = 100;

function createPopup(state) {
	cy.visit("cypress/fixtures/index.html");
	return cy.window().then(({ infoPopup, document }) => {
		var pp = infoPopup(state);
		cy.wrap({ pp, document });
	});
}

describe("Popup should initialize", () => {
	const state = {};

	it("Popup container has loaded on page", () => {
		createPopup(state).then(() => {
			cy.get("#flourish-popup-constrainer").should("exist");
		});
	});
});

describe("Popups and panels show when appropriate", () => {
	let state = {};

	describe("'None' mode", () => {
		it("mouseover: nothing happens", () => {
			state = { mode: "none" };
			createPopup(state).then(({ pp, document }) => {
				pp.setColumnNames({ "name": "Name" });

				pp.mouseover(
					document.querySelector("button"),
					{ name: "Hello!" }
				);
				cy.wait(panel_animation);
				cy.get(".flourish-popup").should("not.visible");
				cy.get(".flourish-panel-content").should("not.exist");
			});
		});
		it("click: nothing happens", () => {
			state = { mode: "none" };
			createPopup(state).then(({ pp, document }) => {
				pp.setColumnNames({ "name": "Name" });

				pp.click(
					document.querySelector("button"),
					{ name: "Hello!" }
				);
				cy.wait(panel_animation);
				cy.get(".flourish-popup").should("not.visible");
				cy.get(".flourish-panel-content").should("not.exist");
			});
		});
	});
	describe("'Popup' mode", () => {
		it("mouseover: shows popup", () => {
			state = { mode: "popup" };
			createPopup(state).then(({ pp, document }) => {
				pp.setColumnNames({ "name": "Name" });

				pp.mouseover(
					document.querySelector("button"),
					{ name: "Hello!" }
				);
				cy.wait(panel_animation);
				cy.get(".flourish-popup").should("be.visible");
				cy.get(".flourish-panel-content").should("not.visible");
			});
		});
		it("click: shows popup", () => {
			state = { mode: "popup" };
			createPopup(state).then(({ pp, document }) => {
				pp.setColumnNames({ "name": "Name" });

				pp.click(
					document.querySelector("button"),
					{ name: "Hello!" }
				);
				cy.wait(panel_animation);
				cy.get(".flourish-popup").should("be.visible");
				cy.get(".flourish-panel-content").should("not.visible");
			});
		});
	});
	describe("'Panel' mode", () => {
		it("mouseover: nothing happens", () => {
			state = { mode: "panel" };
			createPopup(state).then(({ pp, document }) => {
				pp.setColumnNames({ "name": "Name" });

				pp.mouseover(
					document.querySelector("button"),
					{ name: "Hello!" }
				);
				cy.wait(panel_animation);
				cy.get(".flourish-popup").should("not.visible");
				cy.get(".flourish-panel-content").should("not.exist");
			});
		});
		it("click: shows panel", () => {
			state = { mode: "panel" };
			createPopup(state).then(({ pp, document }) => {
				pp.setColumnNames({ "name": "Name" });
				pp.click(
					document.querySelector("button"),
					{ name: "Hello!" }
				);
				cy.wait(panel_animation);
				cy.get(".flourish-popup").should("not.visible");
				cy.get(".flourish-panel-content").should("be.visible");
			});
		});
		it("mouseover: doesn't reset animation when called repeatedly", () => {
			state = {
				mode: "panel",
				panel_position: "right",
				panel_side_fixed: true,
				show_popup_styles: false,
			};

			createPopup(state).then(({ pp, document }) => {
				pp.setColumnNames({ name: "Name" });
				pp.mouseover(
					document.querySelector("button"),
					{ name: "Hello!" }
				);

				cy.get(".flourish-panel-inner").should(($el) => {
					expect(parseInt($el.css("left"), 10)).lt(1000);

					pp.mouseover(
						document.querySelector("button"),
						{ name: "Again!" }
					);

					expect(parseInt($el.css("left"), 10)).lt(1000);
				});
			});
		});
	});
	describe("'Both' mode", () => {
		it("mouseover: popup shows", () => {
			state = { mode: "both" };
			createPopup(state).then(({ pp, document }) => {
				pp.setColumnNames({ "name": "Name" });

				pp.mouseover(
					document.querySelector("button"),
					{ name: "Hello!" }
				);
				cy.wait(panel_animation);
				cy.get(".flourish-popup").should("be.visible");
				cy.get(".flourish-panel-content").should("not.visible");
			});
		});
		it("click: shows panel", () => {
			state = { mode: "both" };
			createPopup(state).then(({ pp, document }) => {
				pp.setColumnNames({ "name": "Name" });
				pp.click(
					document.querySelector("button"),
					{ name: "Hello!" }
				);
				cy.wait(panel_animation);
				cy.get(".flourish-popup").should("not.visible");
				cy.get(".flourish-panel-content").should("be.visible");
			});
		});
	});
});
