(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?module.exports=e():typeof define==="function"&&define.amd?define(e):t.Popup=e()})(this,function(){"use strict";var t=25;var e=5;var i=10;var n=10;var o={};o.bottom=function t(e,o){return{shape:[-i,-n,i,-n],pos:[e/2,o+n]}};o.top=function t(e,o){return{shape:[-i,n,i,n],pos:[e/2,-n]}};o.left=function t(e,o){return{shape:[n,i,n,-i],pos:[-n,o/2]}};o.right=function t(e,o){return{shape:[-n,i,-n,-i],pos:[e+n,o/2]}};o.topLeft=function t(i,o){return{shape:[n+e,n,n,n+e],pos:[-n,-n]}};o.bottomLeft=function t(i,o){return{shape:[n+e,-n,n,-n-e],pos:[-n,o+n]}};o.topRight=function t(i,o){return{shape:[-n-e,n,-n,n+e],pos:[i+n,-n]}};o.bottomRight=function t(i,o){return{shape:[-n-e,-n,-n,-n-e],pos:[i+n,o+n]}};function r(t,o,r,l,p,a,s){var h=r-t/2-n,u=r+t/2+n,f=t/2+Math.min(0,h-p.left)+Math.max(0,u-p.right),d;if(f-i<e){d=[-f,(-n-e)*a,Math.max(i,e-f),-n*a]}else if(f+i>t-e){d=[Math.min(-i,t-f-e),-n*a,Math.min(i,t-f),(-n-e)*a]}else{d=[-i,-n*a,i,-n*a]}return{pos:[f,s],shape:d}}function l(t,o,r,l,p,a,s){var h=l-o/2-n,u=l+o/2+n,f=o/2+Math.min(0,h-p.top)+Math.max(0,u-p.bottom),d;if(f-i<e){d=[(-n-e)*a,-f,-n*a,Math.max(i,e-f)]}else if(f+i>o-e){d=[-n*a,Math.min(-i,o-f-e),(-n-e)*a,Math.min(i,o-f)]}else{d=[-n*a,-i,-n*a,i]}return{pos:[s,f],shape:d}}o.bottomFlexible=function t(e,i,o,l,p){return r(e,i,o,l,p,+1,i+n)};o.topFlexible=function t(e,i,o,l,p){return r(e,i,o,l,p,-1,-n)};o.rightFlexible=function t(e,i,o,r,p){return l(e,i,o,r,p,+1,e+n)};o.leftFlexible=function t(e,i,o,r,p){return l(e,i,o,r,p,-1,-n)};function p(e,i,n,r,l,p){var a=o[e](i,n,r,l,p),s=r-t-a.pos[0],h=l-t-a.pos[1];return{left:s,top:h,right:s+i+2*t,bottom:h+n+2*t}}function a(e,i,n,r,l,p,a,s,h,u){var f=o[e](r,l,s,h,u);i.left=p-t-f.pos[0]+"px";i.top=a-t-f.pos[1]+"px";n.setAttribute("d","M0,0L"+f.shape.join(",")+"Z");n.setAttribute("transform","translate("+(f.pos[0]+t)+","+(f.pos[1]+t)+")")}function s(){var e=this;e.is_visible=true;function i(t){if(e._maxWidth.match(/^\d+(?:\.\d+)?%$/)){return t.width*parseFloat(e._maxWidth)/100}if(e._maxWidth.match(/^\d+(?:\.\d+)?(?:px)?$/)){return parseFloat(e._maxWidth)}if(e._maxWidth!=null){console.error("Popup: Unknown value for maxWidth: "+e._maxWidth)}return t.width}if(!e._point){console.error("Popup: cannot draw popup till point() has been specified");return}var o=document.documentElement.getBoundingClientRect(),r=e._point[0],l=e._point[1],s=e._container.getBoundingClientRect();if(r<s.left)r=s.left;else if(r>s.right)r=s.right;if(l<s.top)l=s.top;else if(l>s.bottom)l=s.bottom;var h=r-o.left,u=l-o.top;var f=e._getElement(),d=f.style,c=f.querySelector(".flourish-popup-svg"),m=c.querySelector("g"),g=m.querySelector("rect"),v=m.querySelector("path"),b=f.querySelector(".flourish-popup-content");d.display="block";b.style.maxWidth=i(s)+"px";if(e._inner_html!=e._html){b.innerHTML=e._inner_html=e._html}var y=b.getBoundingClientRect(),_,x;do{_=Math.ceil(y.width);x=Math.ceil(y.height);d.width=_+2*t+"px";d.height=x+2*t+"px";y=b.getBoundingClientRect()}while(_!=Math.ceil(y.width)||x!=Math.ceil(y.height));g.setAttribute("width",_);g.setAttribute("height",x);c.setAttribute("width",_+2*t);c.setAttribute("height",x+2*t);var M=t-n;var w=null,C=null,E=null,F=Infinity,A=Infinity,k,S;for(var W=0;W<e._directions.length;W++){var q=e._directions[W],R=p(q,_,x,r,l,s),L=Math.max(0,Math.floor(s.left)-R.left-M)+Math.max(0,R.right-Math.ceil(s.right)-M),z=Math.max(0,Math.floor(s.top)-R.top-M)+Math.max(0,R.bottom-Math.ceil(s.bottom)-M);if(L==0&&z==0){w=q;break}if(L<F||L==F&&z<k){F=L;k=z;C=q}if(z<A||z==A&&L<S){A=z;S=L;E=q}}if(w){q=w}else if(e._fallbackFit=="horizontal"){q=C}else if(e._fallbackFit=="vertical"){q=E}else{console.warn("Popup: failed to point box of size ("+_+", "+x+")"+" at ("+r+", "+l+") within ("+s.left+", "+s.top+", "+s.right+", "+s.bottom+")");q=e._directions[0]}a(q,d,v,_,x,h,u,r,l,s);return e}function h(t,e,i){var n=document.createElementNS("http://www.w3.org/2000/svg",t);var o;if(e)for(o in e)n.setAttribute(o,e[o]);var r=n.style;if(i)for(o in i)r[o]=i[o];return n}function u(){var i=this;var n="flourish-popup-"+i.unique_id;var o=document.getElementById(n);if(!o){o=document.createElement("div");o.className="flourish-popup";o.id=n;var r=o.style;r.display="none";r.margin=r.padding=0;r.position="absolute";r.width="80px";r.height="40px";r.boxSizing="border-box";o.addEventListener("click",function(t){i.fire("click",t)},false);var l=h("svg",{class:"flourish-popup-svg"},{position:"absolute",top:0,left:0,bottom:0,right:0});var p=h("filter",{id:"dropshadow-"+i.unique_id,height:"130%"});p.appendChild(h("feGaussianBlur",{in:"SourceAlpha",stdDeviation:5}));p.appendChild(h("feOffset",{dx:0,dy:2,result:"offsetblur"}));var a=h("feComponentTransfer");a.appendChild(h("feFuncA",{type:"linear",slope:.2}));p.appendChild(a);var s=h("feMerge");p.appendChild(s);s.appendChild(h("feMergeNode"));s.appendChild(h("feMergeNode",{in:"SourceGraphic"}));l.appendChild(p);var u=h("g",{filter:"url(#dropshadow-"+i.unique_id+")",fill:"white",stroke:"none"});u.appendChild(h("rect",{x:t,y:t,rx:e}));u.appendChild(h("path"));l.appendChild(u);o.appendChild(l);var f=document.createElement("div");f.className="flourish-popup-content";r=f.style;r.position="absolute";r.top=r.left=t+"px";r.padding="10px";o.appendChild(f);i._getConstrainer().appendChild(o)}i._resizeConstrainer();return o}var f;var d;function c(){if(f)return f;f=document.createElement("div");f.id="flourish-popup-constrainer";d=f.style;d.overflow="hidden";d.pointerEvents="none";d.position="absolute";d.left="0";d.top="0";d.margin="0";d.padding="0";document.body.appendChild(f);this._resizeConstrainer();return f}function m(){if(!f)c.call(this);var t=d.display;d.display="none";d.width=document.documentElement.scrollWidth+"px";d.height=document.documentElement.scrollHeight+"px";d.display=t}var g="2.1.5";var v=1;var b={container:document.body,maxWidth:"70%",point:null,html:null,directions:["bottom","top","left","right","topLeft","bottomLeft","topRight","bottomRight","bottomFlexible","topFlexible","leftFlexible","rightFlexible"],fallbackFit:"horizontal"};function y(){this.unique_id=v++;this.is_visible=true;for(var t in b)this["_"+t]=b[t];this.handlers={click:[]}}function _(t){y.prototype[t]=function(e){if(typeof e=="undefined")return this["_"+t];this["_"+t]=e;return this}}for(var x in b)_(x);y.prototype.point=function(t,e){if(typeof t=="undefined")return this._point;if(Array.isArray(t))this._point=[t[0],t[1]];else if(typeof e!="undefined")this._point=[t,e];else if(t instanceof HTMLElement||t instanceof SVGElement){var i=t.getBoundingClientRect();this._point=[Math.floor(i.left+i.width/2),Math.floor(i.top+i.height/2)]}else{console.error("Popup: could not understand argument")}return this};y.prototype.directions=function(t){if(typeof t==="undefined")return this._directions;if(typeof t==="string")t=[t];this._directions=t.slice();return this};function M(t){return t.replace(/[&<>]/g,function(t){return{"&":"&amp;","<":"&lt;",">":"&gt;"}[t]})}y.prototype.text=function t(e){this._html=M(e);return this};y.prototype.on=function t(e,i){if(!(e in this.handlers))throw new Error("Popup.on: No such event: "+e);this.handlers[e].push(i);return this};y.prototype.fire=function t(e,i){if(!(e in this.handlers))throw new Error("Popup.fire: No such event: "+e);var n=this.handlers[e];for(var o=0;o<n.length;o++){n[o].call(this,i)}return this};y.prototype._getElement=u;y.prototype._getConstrainer=c;y.prototype._resizeConstrainer=m;y.prototype.draw=s;y.prototype.hide=function t(){if(!this.is_visible)return this;this.is_visible=false;this._getElement().style.display="none";return this};function w(){return new y}w.version=g;return w});